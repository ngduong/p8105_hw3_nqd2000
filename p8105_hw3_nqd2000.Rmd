---
title: "P8105_HW3_nqd2000"
author: "Ngoc Duong"
date: "10/10/2019"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r, message = FALSE, warning = FALSE}
library(readr)
library(tidyverse)
library(viridis)
library(ggplot2)
library(leaflet)
library(dplyr)
library(p8105.datasets)
```

## Problem 1 

```{r instacart dataset}
#get instacart dataset 
data(instacart)
```
This `instacart` dataset has `r nrow(instacart)` observations and `r ncol(instacart)` variables. Variables that might be helpful include:
<br /> `aisle`: aisle name (e.g, `r unique(sample(as.factor(pull(instacart,aisle)), 4, replace=FALSE))`, etc.),
<br /> `department`: department name (e.g, `r unique(sample(as.factor(pull(instacart,department)), 4, replace=FALSE))`, etc.),
<br /> `product_name`: name of product ordered (e.g, `r unique(sample(as.factor(pull(instacart,product_name)), 4, replace=FALSE))`, etc.),
<br /> `order_id`: order identifier (observations with the same `order_id` means products ordered are in a same basket, identified by other variables as listed next),
<br /> `order_dow`: day of week when product was ordered (e.g, take "0" as Sunday, "1" as Monday, "2" as Tuesday, and so on),
<br /> `order_hour_of_day`: hour of day when product was ordered (e.g, "1" means 1am, "14" means 2pm, "23" means 11pm, and so on),
<br /> `reordered`: whether the product has been ordered before ("1" means the product has been ordered before and "0" means otherwise),
<br /> and `days_from_prior_order`: number of days between newest order (reorder) and previous order (ranging from 0 days to 30 days).

All these variables are interconnected. Variables with containing `_id` might be more helpful for internal use (efficient information storing), as they correspond with the name ("Bulgarian Yogurt" has `product_id` of 49302, or aisle "Fresh Fruits" has `aisle_id` 24, etc.)

It was noted that the original data is more extensive (having about 3 million observations), and the dataset here is a cleaned and limited version of the original one. Since the variable `eval_set` only contains value `train`, it might be the case that this dataset was subsetted from the original one as a training dataset for some model training purpose.

```{r top aisles}
#calculate the number of orders for each aisle 
top_aisles <- instacart %>% 
                mutate(                              #convert to factor some variables
                  aisle = factor(aisle),
                  department = factor(department)
                ) %>% 
                group_by(aisle) %>%                  #organize dataset by aisle
                summarize(order_count = n()) %>%     #count number of "orders"/frequency within each aisle "group"                            
                mutate(                              #order aisle based on calculated order count for each
                  aisle = fct_reorder(aisle, order_count)
                )
#I used `sum(is.na(instacart))` to check if there was any NA values. Since there was no NA's, I decided not to use the `drop_na()` function.

top_aisles %>% 
  top_n(5) %>%                                       #get top 5 aisles (based on order counts)
  knitr::kable()                                     #create a table 
```

The cleaned dataset (`top_aisles`) on aisles and their order counts is a `r nrow(top_aisles)` x `r ncol(top_aisles)` tibble showing `r nrow(top_aisles)` different aisles and the corresponding number of orders for each aisle. 
From the list above, top 5 aisles with most items ordered are `r top_aisles %>% top_n(5) %>% .[1] %>% pull()`. Among the top 3 aisles with highest order frequencies -- `r top_aisles %>% top_n(3) %>% .[1] %>% pull()`, the order counts are `r top_aisles %>% top_n(3) %>% .[2] %>% pull()`, respectively. 

Now we can use some visualization to look at the aisles and their order counts:

```{r plot items against aisle}
# Make a plot that shows the number of items ordered in each aisle, limiting this to aisles with more than 10000 items ordered. Arrange aisles sensibly, and organize your plot so others can read it.

top_aisles %>% 
    filter(order_count > 10000) %>%      #limit to only aisles with more than 10000 items ordered 
    ggplot(aes(x = aisle,                #start plotting    
               y = order_count,
               fill = order_count)) +
    geom_bar(stat = "identity") +
    viridis::scale_fill_viridis(
      begin = 1, end = 0) +              #specify color range so highest order counts get darker color
    coord_flip() +                       #flip coordinates so aisle names are readable
    labs(                                #add title, x-axis and y-axis titles
      title = "Number of items ordered in each aisle",
      x = "Aisle name",
      y = "Number of items") + 
    theme_bw() +                         #set theme black and white, place legend below plot, and format legend
    theme(legend.position = "bottom",    
          plot.title = element_text(hjust = 0.5, size=12, face='bold')) 
```

The top two aisles with most producted ordered from have approximately twice the product counts as the third most popular aisle (packaged vegetables and fruits). After that product order counts tapered off dramatically as popularity rank decreases.

```{r three most popular items}
## Make a table showing the three most popular items in each of the aisles “baking ingredients”, “dog food care”, and “packaged vegetables fruits”.  Include the number of times each item is ordered in your table.

instacart %>% 
 filter(aisle %in% 
          c("baking ingredients", 
            "dog food care",
            "packaged vegetables fruits")) %>%     #filter out these specific aisles 
    group_by(aisle, product_name) %>%              #organize by product name and aisle to count
    summarize(orders = n()) %>%                    #create variable orders as frequency count of product_name within each aisle
  top_n(n = 3) %>%                                 #select top 3 popular product within each aisle
  arrange(desc(orders), .by_group = TRUE) %>%      #arrange product by descending order of counts
  knitr::kable()                                   #create a table
```

From this table, we can see among aisle `packaged vegetables and fruits`, `organic baby spinach` has the most (and significantly higher) order counts than the second and third product `organic raspeberries`, and `organic blueberries`. 

```{r mean hour of day for PLA and CIC}

instacart %>% 
 filter(product_name %in%                        #select specific products of interest
          c("Pink Lady Apples", 
            "Coffee Ice Cream")) %>% 
 group_by(order_dow, product_name) %>%           #organize by day of order and product
 arrange(order_dow) %>%                          #arrange day of order
 summarize(mean_hour =                           #compute average hour of order for each group
             mean(order_hour_of_day)) %>% 
 ungroup(order_dow) %>%                          #ungroup to mutate
 mutate(order_dow =                              #recode values in day of order
    recode(order_dow, 
       "0"="Sunday",
       "1"="Monday",
       "2"="Tuesday",
       "3"="Wednesday",
       "4"="Thursday",
       "5"="Friday",
       "6"="Saturday")) %>% 
 pivot_wider(names_from = "order_dow",           #create a reader-friendly wide dataframe
             values_from = "mean_hour") %>% 
 knitr::kable(digits = 2)                        #create table and specify decimal numbers
```

From the table, we can see that coffee ice cream was usually ordered at, on average, 2-3pm on weekdays and 12-2pm on weekends, whereas the average hour (of day) for ordering Pink Lady Apples was more around noon and consistent. Since 2-3pm might be the time most people feel tired from working, they might have the tendency to treat themselves (with caffeinated products) and thus coffee ice cream. 


